<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Airton Control</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        :root { --bg: #f5f7fa; --card: #ffffff; --primary: #3498db; --success: #2ecc71; --danger: #e74c3c; --text: #2c3e50; --disabled: #bdc3c7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .card { background: var(--card); padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 360px; text-align: center; margin-top: 20px; position: relative; }
        
        /* Temp√©rature */
        .temp-display { font-size: 3.5rem; font-weight: 700; color: var(--primary); margin: 10px 0; transition: opacity 0.3s; }
        .temp-controls { display: flex; justify-content: center; gap: 20px; margin-bottom: 25px; }
        .circle-btn { width: 60px; height: 60px; border-radius: 50%; border: none; background: #eee; font-size: 24px; cursor: pointer; }
        
        /* Grille et Boutons */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .btn { padding: 15px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; transition: 0.3s; font-size: 1rem; position: relative; }
        .btn-on { background: var(--success); color: white; }
        .btn-off { background: var(--danger); color: white; }
        .btn-mode { background: #ecf0f1; color: var(--text); }
        
        /* Animation de chargement */
        .loading { opacity: 0.6; pointer-events: none; }
        .spinner { display: none; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; position: absolute; right: 10px; top: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Status Bar */
        #status-bar { font-size: 0.8rem; margin-bottom: 10px; color: var(--disabled); }

        /* Config */
        .config-input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        #config-section { display: none; }
        .settings-btn { background: none; border: none; color: #95a5a6; cursor: pointer; margin-top: 25px; }
    </style>
</head>
<body>

    <div id="status-bar">Pr√™t</div>

    <div class="card" id="main-ui">
        <h2>Airton Pro</h2>
        
        <div class="temp-display" id="temp-val">20¬∞C</div>
        
        <div class="temp-controls">
            <button class="circle-btn" onclick="updateTemp(-10)">-</button>
            <button class="circle-btn" onclick="updateTemp(10)">+</button>
        </div>

        <div class="grid">
            <button id="btn-switch-true" class="btn btn-on" onclick="callApi('switch', true)">
                ON <div class="spinner"></div>
            </button>
            <button id="btn-switch-false" class="btn btn-off" onclick="callApi('switch', false)">
                OFF <div class="spinner"></div>
            </button>
        </div>

        <div class="grid">
            <button class="btn btn-mode" onclick="callApi('mode', 'cold')">‚ùÑÔ∏è Froid</button>
            <button class="btn btn-mode" onclick="callApi('mode', 'auto')">üîÑ Auto</button>
            <button class="btn btn-mode" onclick="callApi('heat', true)">üî• Chaud</button>
            <button class="btn btn-mode" onclick="callApi('light', true)">üí° Light</button>
        </div>

        <button class="settings-btn" onclick="showConfig()">‚öôÔ∏è Param√®tres</button>
    </div>

    <div class="card" id="config-section">
        <h3>Configuration</h3>
        <input type="text" id="accId" class="config-input" placeholder="Access ID">
        <input type="password" id="accSec" class="config-input" placeholder="Access Secret">
        <input type="text" id="devId" class="config-input" placeholder="Device ID">
        <button class="btn btn-on" style="width:100%" onclick="saveSettings()">SAUVEGARDER</button>
    </div>

    <script>
        let currentSetpoint = 200;

        function init() {
            const id = localStorage.getItem('tuya_id');
            if (!id) showConfig();
        }

        function showConfig() {
            document.getElementById('main-ui').style.display = 'none';
            document.getElementById('config-section').style.display = 'block';
        }

        function saveSettings() {
            localStorage.setItem('tuya_id', document.getElementById('accId').value);
            localStorage.setItem('tuya_secret', document.getElementById('accSec').value);
            localStorage.setItem('tuya_device', document.getElementById('devId').value);
            location.reload();
        }

        function updateTemp(delta) {
            currentSetpoint += delta;
            if (currentSetpoint < 160) currentSetpoint = 160;
            if (currentSetpoint > 300) currentSetpoint = 300;
            document.getElementById('temp-val').innerText = (currentSetpoint / 10) + "¬∞C";
            callApi('temp_set', currentSetpoint);
        }

        async function callApi(code, value) {
            const statusBar = document.getElementById('status-bar');
            statusBar.innerText = "Envoi en cours...";
            
            // Animation sur le bouton cliqu√© (optionnel)
            const payload = {
                accessId: localStorage.getItem('tuya_id'),
                accessSecret: localStorage.getItem('tuya_secret'),
                deviceId: localStorage.getItem('tuya_device'),
                code: code,
                value: value
            };

            try {
                const response = await fetch('/api/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if (result.success) {
                    statusBar.innerText = "Commande effectu√©e avec succ√®s";
                    setTimeout(() => statusBar.innerText = "Pr√™t", 2000);
                } else {
                    statusBar.innerText = "Erreur : " + result.msg;
                }
            } catch (err) {
                statusBar.innerText = "Erreur de connexion";
            }
        }
        init();
    </script>
</body>
</html>
